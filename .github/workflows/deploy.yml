name: ğŸš€ Deploy Alex HustleFinder AI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  NODE_VERSION: '18'

jobs:
  test:
    name: ğŸ§ª Tests & Quality
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ”§ Install dependencies
      run: npm ci
      
    - name: ğŸ¥ Health check
      run: node backend/health.js
      
    - name: ğŸ”¬ Run smoke tests
      run: |
        node backend/smoke-test-owneridentity.js
        node backend/smoke-test-alexauthenticcore.js  
        node backend/smoke-test-alexintelligentcore.js
        node backend/smoke-test-autonomycore.js
        
    - name: ğŸ“Š Run comprehensive tests
      run: node backend/run-all-smoke-tests.js

  deploy-staging:
    name: ğŸ§‘â€ğŸ’» Deploy Staging
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸš€ Deploy to staging
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.STAGING_HOST }}
        username: ${{ secrets.STAGING_USER }}
        key: ${{ secrets.STAGING_SSH_KEY }}
        script: |
          cd /var/www/alex-staging
          git pull origin main
          npm ci
          node backend/run-all-smoke-tests.js
          pm2 reload ecosystem.config.js --env staging
          echo "âœ… Staging deployed successfully"

  deploy-production:
    name: ğŸ­ Deploy Production
    needs: test
    runs-on: ubuntu-latest
    permissions:
      contents: read
    if: github.ref == 'refs/heads/main'
    environment: production
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸš€ Deploy to Tour A
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.TOUR_A_HOST }}
        username: ${{ secrets.PROD_USER }}
        key: ${{ secrets.PROD_SSH_KEY }}
        script: |
          cd /var/www/alex
          git pull origin main
          npm ci
          node backend/health.js
          pm2 reload ecosystem.config.js --env production
          echo "âœ… Tour A deployed successfully"
          
    - name: ğŸš€ Deploy to Tour B
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.TOUR_B_HOST }}
        username: ${{ secrets.PROD_USER }}
        key: ${{ secrets.PROD_SSH_KEY }}
        script: |
          cd /var/www/alex
          git pull origin main
          npm ci
          node backend/health.js  
          pm2 reload ecosystem.config.js --env production
          echo "âœ… Tour B deployed successfully"
          
    - name: ğŸ” Post-deployment verification
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.TOUR_A_HOST }}
        username: ${{ secrets.PROD_USER }}
        key: ${{ secrets.PROD_SSH_KEY }}
        script: |
          # VÃ©rifier que les services sont up
          sleep 10
          curl -f http://localhost:3000/health || exit 1
          echo "âœ… Health check passed"
          
          # VÃ©rifier les logs pour erreurs critiques
          if tail -20 /var/log/alex/error.log | grep -i "fatal\|critical"; then
            echo "âŒ Critical errors found in logs"
            exit 1
          fi
          
          echo "ğŸ¯ Production deployment successful"

  backup:
    name: ğŸ’¾ Backup Database
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    needs: deploy-production
    
    steps:
    - name: ğŸ—„ï¸ Trigger backup
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.TOUR_A_HOST }}
        username: ${{ secrets.PROD_USER }}
        key: ${{ secrets.PROD_SSH_KEY }}
        script: |
          /var/www/alex/scripts/backup-db.sh
          echo "ğŸ’¾ Database backup completed"
